swagger: '2.0'
info:
  title: Tarbela Event Producer API
  description: |
      This API will be used by Tarbela to access events from a producer, which
      need to be published to Nakadi (or maybe to other event message sinks).
      After delivery Tarbela will use the status_update links to inform the producers
      about the success (or the failure).
  version: '0.1'
  contact:
      name: Team Lumberjack
      email: team-lumberjack@zalando.ie

#basePath: /api
#produces:
#  - application/json

paths: 
  /new-events:
    parameters:
      - $ref: '#/parameters/Flow-Id'
    get:
      summary: retrieve a bunch of new events
      description: bla bla bla
      responses:
        200:
          description: OK
          schema:
            $ref: '#/definitions/Bunch-of-Events'

  /event/{eid}/status:
    parameters:
      - $ref: '#/parameters/Flow-Id'
      - name: eid
        in: path
        type: string
        description: the event identifier.
        required: true
    put:
      summary: update the status of the event delivery.
      description: This updates the status of the event delivery.
      parameters:
        - name: update
          in: body
          schema:
            type: object
            properties:
              status:
                type: string
                enum:
                  - SENT
                  - ERROR
                  - NEW
              delivery_error:
                $ref: '#/definitions/Problem'
      responses:
        200:
          description: OK
    

parameters:
  Flow-Id:
    name: X-Flow-ID
    description: |
      A custom header that will be passed onto any further requests and can be used for diagnosing.
    in: header
    type: string
    required: false
  
definitions:
  Bunch-of-Events:
    type: object
    properties:
      _links:
        type: object
        properties:
          next:
            type: object
            properties:
              href:
                type: string
                format: uri
      events:
        type: array
        items:
          $ref: "#/definitions/Event"
  Event:
    description:
      An event which will be delivered to Nakadi. For a data change event
      the data_type and data_op fields are required too, for business events
      not.
    type: object
    properties:
      _links:
        type: object
        properties:
          status_update:
            type: object
            properties:
              href:
                type: string
                format: uri
                description:
                  Tarbela will use this URI with a PUT to send the status update.
                x-interface:
                  $ref: '#/paths/~1event~1{id}~1status'
      data:
        description: |
          The JSON data payload to be sent to Nakadi. TODO: Is this an
          object or a string?
        type: object
      metadata:
        type: object
        properties:
          eid:
            description: |
              Identifier of this Event.
              Clients MUST generate this value and it SHOULD be guaranteed to be unique from the
              perspective of the producer. Consumers MIGHT use this value to assert uniqueness of reception
              of the Event.
            type: string
            example: '105a76d8-db49-4144-ace7-e683e8f4ba46'
          event_type:
            description: |
              The EventType of this Event. This will decide which Nakadi topic this event will be sent to.
            type: string
            example: 'pennybags.payment-business-event'
          occurred_at:
            description: |
              Timestamp of creation of the Event generated by the producer.
            type: string
            format: date-time
            example: '1996-12-19T16:39:57-08:00'
          parent_eids:
            type: array
            items:
              type: string
              format: uuid
            description: |
              Event identifier of the Event that caused the generation of this Event.
              Set by the producer.
            example: '105a76d8-db49-4144-ace7-e683e8f4ba46'
          flow_id:
            description: |
              The flow-id of the producer of this Event.
            type: string
            example: 'JAh6xH4OQhCJ9PutIV_RYw'
          partition:
            description: |
              Indicates the partition assigned to this Event.
              Required to be set by the client if partition strategy of the EventType is 'user_defined'.
            type: string
            example: '0'
        required:
          - eid
          - occurred_at
          - event_type
        additionalProperties: false
      data_type:
        type: string
        example: 'pennybags:order'
      data_op:
        type: string
        enum: ['C', 'U', 'D', 'S']
        description: |
          The type of operation executed on the entity.
          * C: Creation
          * U: Update
          * D: Deletion
          * S: Snapshot

    required:
      - metadata
      - data
      - _links
      
  Problem:
    type: object
    properties:
      type:
        type: string
        format: uri
        description: |
          An absolute URI that identifies the problem type.  When dereferenced,
          it SHOULD provide human-readable documentation for the problem type
          (e.g., using HTML).
        example: http://httpstatus.es/503
      title:
        type: string
        description: |
          A short, summary of the problem type. Written in english and readable
          for engineers (usually not suited for non technical stakeholders and
          not localized); example: Service Unavailable
      status:
        type: integer
        format: int32
        description: |
          The HTTP status code generated by the origin server for this occurrence
          of the problem.
        example: 503
      detail:
        type: string
        description: |
          A human readable explanation specific to this occurrence of the
          problem.
        example: Connection to database timed out
      instance:
        type: string
        format: uri
        description: |
          An absolute URI that identifies the specific occurrence of the problem.
          It may or may not yield further information if dereferenced.
    required:
      - type
      - title
      - status
